<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <title>Test Checkout</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <script src="https://checkout.razorpay.com/v1/checkout.js"></script>
  <style>
    body { font-family: system-ui, Arial; max-width: 720px; margin: 24px auto; padding: 16px; }
    label { display:block; margin-top: 8px; }
    input, button, textarea { padding: 8px; margin-top: 4px; width:100%; }
    .row { display:grid; grid-template-columns: 1fr 1fr; gap: 12px; }
  </style>
</head>
<body>
  <h2>Test Amazon-like Checkout</h2>

  <p><strong>Step 1:</strong> Enter a real <code>productId</code> from <a href="/api/products" target="_blank">/api/products</a> and quantity. (You can add multiple lines — one is enough for testing.)</p>

  <div class="row">
    <div>
      <label>Product ID</label>
      <input id="pid1" placeholder="Paste a real _id from /api/products" />
    </div>
    <div>
      <label>Qty</label>
      <input id="qty1" type="number" min="1" value="1" />
    </div>
  </div>

  <h3>Address</h3>
  <div class="row">
    <div><label>Name</label><input id="name" value="Piyush Poddar" /></div>
    <div><label>Phone</label><input id="phone" value="9999999999" /></div>
  </div>
  <label>Line 1</label><input id="line1" value="221B Baker Street" />
  <label>Line 2</label><input id="line2" value="" />
  <div class="row">
    <div><label>City</label><input id="city" value="Kolkata" /></div>
    <div><label>State</label><input id="state" value="WB" /></div>
  </div>
  <label>Pincode</label><input id="pincode" value="700001" />

  <button id="btnCreate" style="margin-top:16px;">Create Order & Pay</button>

  <pre id="log" style="margin-top:16px; background:#f8f8f8; padding:12px; overflow:auto; max-height:260px;"></pre>

  <script>
  // ✅ Put your TEST key here
  const RZP_KEY_ID = "rzp_test_RAen5MzMyPI8c9";

  const $ = (id) => document.getElementById(id);
  const log = (msg) => {
    const l = $("log");
    l.textContent += (typeof msg === "string" ? msg : JSON.stringify(msg, null, 2)) + "\n";
  };

  $("btnCreate").addEventListener("click", async () => {
    try {
      const productId = $("pid1").value.trim();
      const qty = parseInt($("qty1").value || "1", 10);
      if (!productId) return alert("Paste a real productId from /api/products");
      if (!qty || qty < 1) return alert("Qty must be >= 1");

      const body = {
        items: [{ productId, qty }],
        address: {
          name: $("name").value.trim(),
          phone: $("phone").value.trim(),
          line1: $("line1").value.trim(),
          line2: $("line2").value.trim(),
          city: $("city").value.trim(),
          state: $("state").value.trim(),
          pincode: $("pincode").value.trim(),
        },
      };

      log("Creating order...");
      const r = await fetch("/api/order/create", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(body),
      });
      const data = await r.json();
      log(data);

      if (!data?.rpOrder?.id) {
        return alert("Failed to create Razorpay order. Check server logs.");
      }

      const options = {
        key: RZP_KEY_ID,
        order_id: data.rpOrder.id,
        name: "My Test Shop",
        description: "Cart Payment",
        handler: async function (resp) {
          // resp = { razorpay_order_id, razorpay_payment_id, razorpay_signature }
          console.log("RZP RESP:", resp);
          log("Payment success, verifying signature...");
          const vr = await fetch("/api/payment/verify", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(resp),
          });
          const v = await vr.json();
          console.log("VERIFY RESULT:", v);
          log(v);
          if (v.ok) {
            alert("Payment verified ✅");
            window.open("/admin.html", "_blank");
          } else {
            alert("Payment verification failed ❌");
          }
        },
        modal: {
          ondismiss: function () { log("Popup closed."); }
        },
        prefill: { name: $("name").value, contact: $("phone").value },
        notes: { mongo_order_id: data.orderId },
        theme: { color: "#3399cc" },
      };

      const rz = new window.Razorpay(options);

      // (optional) see exact failure reason
      rz.on("payment.failed", (resp) => {
        console.log("FAILED:", resp.error);
        alert("Payment failed: " + (resp.error?.description || "Unknown"));
      });

      rz.open();
    } catch (e) {
      console.error(e);
      log(e.message || e);
    }
  });
</script>

</body>
</html>
